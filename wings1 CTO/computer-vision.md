# Computer Vision

## Hands-On Activity

### Object Detection

The hands-on exercise will go through how to use a pre-trained YOLO model for object detection.

```py
# packages needed for computer vision
import argparse
import os
import matplotlib.pyplot as plt
from matplotlib.pyplot import imshow
import scipy.io
import scipy.misc
import numpy as np
import pandas as pd
import PIL
from keras.models import load_model, Model
from keras import backend as K
import tensorflow as tf

from utils import read_classes, read_anchors, generate_colors, preprocess_image, draw_boxes, scale_boxes

from yad2k.models.keras_yolo import yolo_head, yolo_boxes_to_corners, preprocess_true_boxes, yolo_loss, yolo_body
```

The pre-trained model weights can be downloaded using the following lines of code (run in terminal):

```shell
# download weights file
curl -O https://pjreddie.com/media/files/yolov2-tiny-voc.weights 
python yad2k.py yolo_tiny.cfg yolov2-tiny-voc.weights model_data/yolo_tiny.h5
```

The `yolow_filter_boxes` function can be used to filter out boxes (generated by the YOLOv8 algorithm) that have low scores, using class and probability thresholds.

```py
import numpy as np

def yolo_filter_boxes(box_confidence, boxes, box_class_probs, threshold=0.6):
    """
    Filters YOLO boxes based on object and class confidence scores.
    """
    # Compute the box scores byt multiplying the box_confidence with the box_class_probs
    box_scores = box_confidence * box_class_probs
    
    # Extracts class indices of maximum score and the corresponding score value  
    box_class_scores = np.max(box_scores, axis=-1)
    box_classes = np.argmax(box_scores, axis=-1)
    
    # Filter out the box_scores above a threshold   
    filtering_mask = box_class_scores >= threshold
    
    # Apply the mask to scores, boxes and classes
    scores = box_class_scores[filtering_mask]
    boxes = boxes[filtering_mask]
    classes = box_classes[filtering_mask]
    
    return scores, boxes, classes
```

The following function implements non-max supression to filter out only the less relevant object detection boxes.

```py
import tensorflow as tf
from keras import backend as K

def yolo_non_max_suppression(scores, boxes, classes, max_boxes=10, iou_threshold=0.5):
    """
    Applies Non-max suppression to set of boxes.
    """
    # Create a tensor to hold the maximum number of boxes
    max_boxes_tensor = tf.Variable(max_boxes, dtype=tf.int32)
    
    # Initialize the variable
    K.get_session().run(tf.variables_initializer([max_boxes_tensor]))
    
    # Use tf.image.non_max_suppression() to get the indices of boxes to keep
    nms_indices = tf.image.non_max_suppression(boxes, scores, max_boxes, iou_threshold)
    
    # Use tf.gather() to select only the boxes, scores, and classes we want to keep
    scores = tf.gather(scores, nms_indices)
    boxes = tf.gather(boxes, nms_indices)
    classes = tf.gather(classes, nms_indices)
    
    return scores, boxes, classes
```

Below is the evaluation function for the YOLOv8 algorithm.

```py
import tensorflow as tf

def yolo_eval(yolo_outputs, image_shape=(720., 1280.), max_boxes=5, score_threshold=0.6, iou_threshold=0.5):
    """
    Converts the output of the YOLO model into usable bounding box tensors.
    """
    # Unpack the YOLO outputs
    box_xy, box_wh, box_confidence, box_class_probs = yolo_outputs
    
    # Convert boxes from center-width to corner format
    boxes = yolo_boxes_to_corners(box_xy, box_wh)

    # Filter the boxes using the score threshold
    scores, boxes, classes = yolo_filter_boxes(box_confidence, boxes, box_class_probs, score_threshold)
    
    # Scale the boxes back to the original image shape
    boxes = scale_boxes(boxes, image_shape)
    
    # Apply Non-Max Suppression to eliminate overlapping boxes
    scores, boxes, classes = yolo_non_max_suppression(scores, boxes, classes, max_boxes, iou_threshold)
    
    return scores, boxes, classes
```